openapi: 3.0.3
info:
  title: Open Librarian API
  description: API documentation for Open Librarian - Intelligent Search Service
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:8080/api/v1
    description: Local API Server
  - url: http://localhost:8080
    description: Local Server (Root)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- Auth & User ---
    User:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        email:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    CreateUserRequest:
      type: object
      required:
        - username
        - email
        - password
      properties:
        username:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          format: password
    
    AuthRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/User'

    RefreshTokenRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string
    
    UpdateUserRequest:
      type: object
      properties:
        email:
          type: string
    
    ChangePasswordRequest:
      type: object
      required:
        - old_password
        - new_password
      properties:
        old_password:
          type: string
        new_password:
          type: string

    # --- Articles ---
    ArticleRequest:
      type: object
      required:
        - title
        - content
      properties:
        title:
          type: string
        content:
          type: string
        original_url:
          type: string
        author:
          type: string
        created_date:
          type: string
          format: date-time
          description: RFC3339 format (e.g., "2023-12-25T15:30:00Z")

    ArticleResponse:
      type: object
      properties:
        id:
          type: string
        message:
          type: string

    Article:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        content:
          type: string
        summary:
          type: string
        tags:
          type: array
          items:
            type: string
        author:
          type: string
        created_date:
          type: string
          format: date-time
        lang:
          type: string
        original_url:
          type: string

    UserArticlesRequest:
      type: object
      properties:
        date_from:
          type: string
          format: date-time
        date_to:
          type: string
          format: date-time
        size:
          type: integer
        from:
          type: integer

    UserArticlesResponse:
      type: object
      properties:
        articles:
          type: array
          items:
            $ref: '#/components/schemas/Article'
        total:
          type: integer

    # --- Search ---
    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
        size:
          type: integer
        from:
          type: integer
        date_from:
          type: string
        date_to:
          type: string
        session_id:
          type: string

    SearchResponse:
      type: object
      properties:
        answer:
          type: string
        sources:
          type: array
          items:
            $ref: '#/components/schemas/SearchResultWithScore'
        took:
          type: integer

    SearchResultWithScore:
      type: object
      properties:
        article:
          $ref: '#/components/schemas/Article'
        score:
          type: number
          format: float
        source:
          type: string
          description: value is keyword or vector

    KeywordSearchResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/Article'
        total:
          type: integer
        took:
          type: integer

    # --- Chat History ---
    ChatSession:
      type: object
      properties:
        id:
          type: string
        user_id:
          type: string
        title:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'

    ChatMessage:
      type: object
      properties:
        role:
          type: string
        content:
          type: string

    # --- Errors ---
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string

security:
  - BearerAuth: []

paths:
  /health:
    get:
      summary: Health Check
      description: Check server status
      tags:
        - System
      security: []
      servers:
        - url: http://localhost:8080
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  time:
                    type: string
  
  # Note: The server mounts /api/v1 prefix for the following routes
  /articles:
    post:
      summary: Add Article
      tags:
        - Articles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArticleRequest'
      responses:
        '201':
          description: Article added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleResponse'
    
  /articles/upload:
    post:
      summary: Upload Article File
      tags:
        - Articles
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '201':
          description: File uploaded and indexed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleResponse'

  /articles/{id}:
    get:
      summary: Get Article
      tags:
        - Articles
      security: [] # Public route
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Article details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Article'
        '404':
          description: Not found

    delete:
      summary: Delete Article
      tags:
        - Articles
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Article deleted
        '404':
          description: Not found

  /articles/user:
    post:
      summary: Get User Articles
      tags:
        - Articles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserArticlesRequest'
      responses:
        '200':
          description: List of user articles
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserArticlesResponse'

  /search:
    post:
      summary: Semantic Search
      tags:
        - Search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

  /search/keyword:
    get:
      summary: Keyword Search
      tags:
        - Search
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
        - in: query
          name: lang
          schema:
            type: string
        - in: query
          name: size
          schema:
            type: integer
            default: 10
        - in: query
          name: from
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeywordSearchResponse'

  /users:
    post:
      summary: Register User
      tags:
        - Users
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /users/auth:
    post:
      summary: Authenticate User
      tags:
        - Users
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /users/refresh:
    post:
      summary: Refresh Token
      tags:
        - Users
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: New token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /users/me:
    get:
      summary: Get Current User
      tags:
        - Users
      responses:
        '200':
          description: Current user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /users/{id}:
    get:
      summary: Get User by ID
      tags:
        - Users
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    
    put:
      summary: Update User
      tags:
        - Users
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated
    
    delete:
      summary: Delete User
      tags:
        - Users
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User deleted

  /users/{id}/password:
    put:
      summary: Change Password
      tags:
        - Users
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
      responses:
        '200':
          description: Password changed

  /users/username/{username}:
    get:
      summary: Get User by Username
      tags:
        - Users
      parameters:
        - in: path
          name: username
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /chat/history:
    get:
      summary: Get Chat History Sessions
      tags:
        - Chat
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: size
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChatSession'

  /chat/history/{id}:
    get:
      summary: Get Chat Session
      tags:
        - Chat
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatSession'
    
    delete:
      summary: Delete Chat Session
      tags:
        - Chat
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session deleted

  /languages:
    get:
      summary: Get Supported Languages
      tags:
        - Utilities
      responses:
        '200':
          description: List of languages
          content:
            application/json:
              schema:
                type: object
                properties:
                  languages:
                    type: array
                    items:
                      type: string

  # --- External Agent Routes ---
  /external/articles:
    get:
      summary: List Articles (External)
      tags:
        - External
      security: []
      parameters:
        - in: query
          name: lang
          schema:
            type: string
        - in: query
          name: author
          schema:
            type: string
        - in: query
          name: size
          schema:
            type: integer
            default: 20
        - in: query
          name: from
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of articles
  
  /external/articles/{id}:
    get:
      summary: Get Article (External)
      tags:
        - External
      security: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Article info

  /external/search:
    post:
      summary: Search (External)
      tags:
        - External
      security: []
      requestBody:
        content:
          application/json:
             schema:
               $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: Search results

  /external/search/keyword:
    get:
      summary: Keyword Search (External)
      tags:
        - External
      security: []
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Results
